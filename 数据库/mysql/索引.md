# 索引

## 索引常见的模型


## InnoDB的索引模型

InnoDB使用B+树索引模型。  
主键列为id，字段k有索引。
```sql
 create table T(
     id int primary key, 
    k int not null, 
    name varchar(16),
    index (k))engine=InnoDB;
```
![](../img/索引-1.png)
根据叶子节点内容：主键索引和非主键索引。  
* 主键索引的叶子节点存的是整行数据。也被称为聚集索引(clustered index).
* 非主键索引的叶子节点存的是主键的值。也称为二级索引(Secondary index).

<strong>基于主键索引和普通索引的查询有什么区别?</strong>  
* 如果是`select * from T where id = 500`主键查询方式，则只需要搜索id这个B+树。
* 如果`select * from T where k = 5`,普通索引方式，需要先搜索K索引树，得到id值500，再到id索引树搜索一次，这过程称为<strong>回表</strong>。

我们尽量使用主键查询。

### 索引维护

### 覆盖索引
如果执行的语句是 select ID from T where k between 3 and 5，这时只需要查 ID 的值，而 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引 k 已经"覆盖了"我们的查询需求，我们称为覆盖索引。  
<strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong>

### 最左前缀原则
B+ 树这种索引结构，可以利用索引的"最左前缀"，来定位记录。(name,age)联合索引  
![](../img/索引-2.png)
索引项是按照索引定义里面出现的字段顺序排序的。
<strong>建立联合索引的时候，如何安排索引内的字段顺序，索引复用能力，因为支持最左原则，(a,b)联合索引，不需要再单独在a上建立索引，第一原则是通过调整顺序，减少维护一个索引；如果单独要做b的查询，则同时需要维护(a,b),(b)两个索引；这时考虑空间问题，name字段比age字段大，则创建(name,age)联合索引，(age)单字段索引。</strong>

### 索引下推
如果满足最左前缀原则，可以在索引中定位记录，那么不符合左前缀的部分呢？  
```sql
select * from tuser where name like '张 %' and age=10 and ismale=1;
```
这个语句搜索时，只能用"张",找到第一个满足条件的ID3，在<strong>Mysql5.6</strong>之前，只能从ID3开始一个个回表，找到主键索引上的数据行，比较字段值。在<strong>Mysql5.6</strong>开始，引入了<strong>索引下推</strong>(index condition pushdown)，在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。  
无索引下推
![](../img/索引-3.png)
索引下推
![](../img/索引-4.png)

## 面试题精选
### 索引有几种类型？分别如何创建?
索引两种分类方式：逻辑分类和物理分类，逻辑分类：  
* 主键索引：一张表只能有一个主键索引，不允许重复、不允许NULL；  
* 唯一索引：数据列不允许重复，允许NULL值，一张表可有多个唯一索引，但是唯一一个索引只能包含一列，比如身份证号码、卡号等可以作为唯一索引；
* 普通索引：一张表可以创建多个普通索引，一个普通索引可以包含多个字段，允许数据重复，允许NULL值插入；
* 全文索引：让搜索关键词更高效的一种索引。

按照物理分类：  
* 聚集索引：一般是表中的主键索引，如果表中没有显示指定主键，则会选择表中的第一个不允许NULL的唯一索引，如果没有的话，就采用Innodb存储引擎为每行数据内置<strong>6字节ROWID</strong>作为聚集us噢因。每一张表只有一个聚集索引，因为聚集索引的键值的逻辑顺序决定了表中相应行的物理顺序。聚集索引在精确查找和范围查找方面有良好的性能表现，聚集索引选择需要慎重，(一般不会让没有语义的自增id充当聚集索引)。
* 非聚集索引：该索引的逻辑顺序与磁盘上行的物理存储顺序不同，一个表可以拥有多个非聚集索引。

索引创建脚本：  
```sql
-- 创建主键索引
alter table t add primary key add (`id`);
-- 创建唯一索引
alter table t add unique (`username`);
-- 创建普通索引
alter table t add index index_name (`username`);
-- 创建全文索引
alter table t add fulltext (`username`);
```

### 什么是最左匹配原则？它的生效原则有哪些？
最左原则也叫最左前缀原则，说的是索引以最左边的为起点任何连续的索引都能匹配上，当遇到范围查询(>,<,betweeb,like)就会停止匹配。生效原则示例，表中有一个联合索引字段index(a,b,c)： 
* where a = 1 只使用索引a；
* where a =1 and b = 2 只使用了索引a,b
* where a = 1 and b = 2 and c = 3,使用了abc
*  where b = 1 or c =1 不适用索引
*  where a = 1 and c = 3 只用索引a
*  where a = 1 and b like 'XX%' and c = 3 只使用了索引a,b

### 什么是前缀索引？为什么要使用？什么情况使用
* 前缀索引也叫局部索引，比如给身份证前10位添加索引，类似于某列部分信息添加索引的方式
* 前缀索引能有效减小索引文件的大小，让每个索引也可以保存更多的索引值，从而提高了索引查询的速度。但是前缀索引也有它的缺点，不能再order by或group by触发前缀索引，也不能用于覆盖索引。
* 当字符串本身可能比较长，而且前几个字符开始不相同，适合使用前缀索引；

给手机号前6位创建索引:
```sql
alter table t add index index_phone(phone(6));
create index index_phone on t(phone(6));
```
[其他参加gitchat-mysql专栏](https://gitbook.cn/gitchat/column/5d80aea449b2b1063b52990f/topic/5d80b1f649b2b1063b529956)