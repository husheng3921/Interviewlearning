# 内存管理


## 伙伴系统(buddy system)
[参考](https://blog.csdn.net/rikeyone/article/details/85054231)
### 背景
伙伴系统是<strong>内核中用来管理物理内存的一种算法</strong>；内核中会将内存按照页来组织分配，随着进程的申请和释放，内存区域会不断碎片化；伙伴系统就是为了解决这种问题.  
伙伴系统将要管理的物理内存按照页面个数分为不同的组，分成11个组，大小不同的连续内存，每组中的内存块大小相等，大小为2的幂次个物理页(4KB)   
系统就存在2^0 ~ 2^10 这么11种大小不同的内存块。对应大小4KB~2^10*4KB  
### 内存分配
当分配内存时，会优先从需要分配的内存块链表上查找空闲的链表，发现对应大小的内存块都被使用后，那么会更大一级的内存上分配一块内存，一半给我们使用，另一半释放到对应大小的内存块链表上。  
比如我们想分配一个8KB内存块，发现对应内存已经没有了，则伙伴系统从16KB中查找一个空闲内存块，分成2半，其中一个8KB返回给申请者，剩下的8KB放到对应8KB内存块链表中进行管理。

### 内存释放
当释放内存时，会扫描对应大小的内存块链表，查看是否在地址连续在一起的内存块，如果发现，那么就合并两个内存块放置到更大一级的内存块链表上。   
比如我们释放8KB大小的内存，那么会对应的链表扫描是否有能够合并的内存块，如果另一个8KB大小的内存和我们使用的地址内存地址连续，那么就合并成一个16KB的内存块，然后接着扫描16KB的内存块链表，继续合并下去。
### 最大分配内存限制
一共有<strong>11个链表，最大order10，最大可分配4KB*2^10=4MB</strong>

