# 

## tcpdump使用

![](./img/tcpdump-1.png)

![](./img/tcpdump-2.png)

```
时间戳 协议 源地址. 源端口 > 目的地址. 目的端口 网络包详细信息
```

## TIME_WAIT

### 作用
* 确保最后的ACK能让被动方关闭接收，从而帮助其正常关闭。
> 
* 让旧连接的重复分节在网络中自然消失

### TIME_WAIT的危害
* 内存资源占用，
* 端口资源的占用

### 如何优化TIME_WAIT

* net.ipv4.tcp_max_tw_buckets
通过命令将系统值调小，默认为18000，超过这个值，系统将所有的TIME_WAIT连接状态重置，并打印出警告信息。(过于暴力不推荐使用)

* net.ipv4.tcp_tw_reuse: 更安全的设置

从协议角度理解如果是安全可控的，可以复用处于TIME_WAIT的套接字为新连接所使用。
安全可控主要有两点：
* 只适用于连接发起方（客户端）
* 对应的TIME_WAIT状态连接创建时间超过1秒才可被复用

同时打开TCP时间戳的支持
net.ipv4.tcp_timestamps = 1.


## 一些有趣场景

* 糊涂窗口综合症，这个场景需要在接收端优化，接收端不能在接收缓冲区空出一个很小的部分，就向发送窗口更新通知，而是要在自己的缓冲区大到一个合理值之后，再向发送端发送窗口更新通知。
* Nagle算法：本质就是限制大批量的小数据包同时发送，因此，在任何一个时刻，未被确认的小数据包不能超过一个。这里的小数据包，指的是长度小于最大报文段长度MSS的TCP分组。发送端就阔以把接下来的几个小数据包存起来，等待接收到前一个小数据包的ACK分组之后，再将数据一次性发送出去。（发送端优化）
* 延时ACK，在收到数据后并不马上回复，而是累计需要发送的ACK报文，等到有数据需要发送给对端是，将累计的ACK捎带一并发送出去。延时ACK机制，不能无限地延时下去，否则发送端误认为数据包没有发送成功，引起重传。反而占用额外的网络带宽